<!DOCTYPE HTML>
<html lang="en">
<head>
    <title>Breathe Together</title>
    <style>
        body {
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #000000;
        }

        #container {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #meditationCanvas {
            display: block;
        }
    </style>
</head>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"
        integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg=="
        crossorigin="anonymous">
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.0.4/socket.io.js"
        integrity="sha512-aMGMvNYu8Ue4G+fHa359jcPb1u+ytAF+P2SCb+PxrjCdO3n3ZTxJ30zuH39rimUggmTwmh2u7wvQsDTHESnmfQ=="
        crossorigin="anonymous">
</script>
<canvas id="meditationCanvas"></canvas>
<script type="text/javascript" charset="utf-8" > // 
        $(document).ready(function () {

            const meditationCanvas = document.getElementById('meditationCanvas');
            meditationCanvas.width = window.innerWidth;
            meditationCanvas.height = window.innerHeight;
            const ctx = meditationCanvas.getContext('2d');

            const radius_scale = 0.5;

            const min_radius = 50 * radius_scale;
            const start_radius = 110 * radius_scale;
            const fast_radius_start = 110 * radius_scale;
            const fast_radius_end = 265 * radius_scale;
            const max_radius = 375 * radius_scale;

            var lockon_distance = 30;

            const max_ring_width = 166  * radius_scale

            const color_change = 0.25;
            const radius_change = 0.6 * radius_scale;
            const init_speed_factor = 1.3;
            var speed_factor = init_speed_factor;
            const max_speed = 2.4;
            const min_speed = 0.7;
            const init_breaths_per_min = 7;
            var breaths_per_min = init_breaths_per_min;

            // const inhale_speed_boost = 1.35;
            const inhale_speed_boost = 1.0; 
            const out_of_bounds_slowdown = 4;

            var speed_multiplier_server = 0;
            var speed_multiplier_client = 0;

            const ring_color = "rgba(255,255,255"

            var circle_color1 = "rgb(11, 150, 230)";
            var circle_color2 = "white"
            
            var time_in_session = -1;
            var timer_on = true;

            var session_duration = 2;
            var start_time = (new Date).getTime()

            user_id = 0;

            const x_pos = meditationCanvas.width / 2;
            const y_pos = meditationCanvas.height * 0.32;

            var circle_client = {
                x: x_pos,
                y: y_pos,
                radius: start_radius,
                outer_radius: start_radius + max_ring_width,
                ring_width: max_ring_width,
            };

            var num_breaths = 0;
            const timeout_counter = 20000;
            var num_active;
            var last_client_event = 'paused';

            var out_of_bounds = false;
            var start_screen = true;
            var paused = false;

            // Connect to the Socket.IO server.
            var socket = io("/");
            console.log(socket)

            function timeout(prev_num_breaths) {
                if (prev_num_breaths == num_breaths) {
                    socket.emit('timeout');
                    paused = true;
                }
            }

            function createInnerCircle(circle) {
                const gradient = ctx.createLinearGradient(circle.x - circle.radius, circle.y - circle.radius, circle.x - circle.radius, circle.y + 1.25 * circle.radius);

                gradient.addColorStop(1, circle_color1)
                gradient.addColorStop(0, circle_color2)

                return gradient;
            }

            function createOuterCircle(circle){
                const gradient2 = ctx.createRadialGradient(circle.x, circle.y, 0, circle.x, circle.y, circle.outer_radius);
                
                gradient2.addColorStop(0, ring_color + ', 0)');
                gradient2.addColorStop(circle.radius / circle.outer_radius, ring_color + ', 0.16)');
                gradient2.addColorStop(1, ring_color + ', 0)');

                return gradient2;
            }

            function drawInnerCircle(circle) {
                const gradient = createInnerCircle(circle);
                ctx.beginPath();
                ctx.arc(circle.x, circle.y, circle.radius, 0, 2 * Math.PI);
                ctx.fillStyle = gradient;
                ctx.fill();
            }

            function drawOuterCircle(circle) {
                const gradient = createOuterCircle(circle);
                ctx.beginPath();
                ctx.arc(circle.x, circle.y, circle.outer_radius, 0, 2 * Math.PI);
                ctx.fillStyle = gradient;
                ctx.fill();
            }

            function animate() {
                ctx.clearRect(0, 0, meditationCanvas.width, meditationCanvas.height);

                if (num_breaths > 0) {
                    drawInnerCircle(circle_client)
                    drawOuterCircle(circle_client);
                }

                if (start_screen){
                    const meditationCanvas = document.getElementById('meditationCanvas');
                    meditationCanvas.width = window.innerWidth;
                    meditationCanvas.height = window.innerHeight;
                    const ctx = meditationCanvas.getContext('2d');
                    ctx.fillStyle = "rgba(140,140,140,0.05)";
                    ctx.fillRect(meditationCanvas.width / 2 - 320, 0, 320 * 2, window.innerHeight)
                }

                requestAnimationFrame(animate);
            }

            function key_down_response(event) {
                if (last_client_event != 'inhale') {
                    socket.emit('client_keydown');
                    num_breaths = num_breaths + 1;
                    setTimeout(timeout, timeout_counter * init_breaths_per_min / breaths_per_min, num_breaths);
                    last_client_event = 'inhale'
                    paused = false;                      
                }
            }

            function key_up_response(event) {
                if (last_client_event == 'inhale') {
                    socket.emit('client_keyup');
                    num_breaths = num_breaths + 1;
                    setTimeout(timeout, timeout_counter * init_breaths_per_min / breaths_per_min, num_breaths);
                    last_client_event = 'exhale'   
                }
            }

            // Add event listener for the "keydown" event on the document object
            document.addEventListener('keydown', (event) => {
                if (event.code === 'Space') {
                    // Prevent default behavior of the spacebar key
                    event.preventDefault();
                }
                if (event.code === 'Esc') {
                    toggle_fullscreen("off")
                } else {
                    key_down_response(event)
                }

            });

            // Add event listener for the "keyup" event on the document object
            document.addEventListener('keyup', (event) => {
                key_up_response(event)
            });

            // Add event listener for the "keydown" event on the document object
            document.addEventListener('mousedown', (event) => {
                key_down_response(event)
            });

            // Add event listener for the "keyup" event on the document object
            document.addEventListener('mouseup', (event) => {
                key_up_response(event)
            });

            // Add event listener for the "keydown" event on the document object
            document.addEventListener('touchstart', (event) => {
                key_down_response(event)
            });

            // Add event listener for the "keyup" event on the document object
            document.addEventListener('touchend', (event) => {
                key_up_response(event)
            });

            window.onbeforeunload = function () {
                socket.emit('leave');
            }

            function start_session() {
                const instructions = document.getElementById("instructions"); 
                instructions.style.display = "none"
                const instructions2 = document.getElementById("instructions2"); 
                instructions2.style.display = "none"

                const header = document.getElementById("header"); 
                header.style.display = "none"

                const line1 = document.getElementById("line1"); 
                line1.style.display = "none"

                const press = document.getElementById("press"); 
                press.style.display = "none"
                const release = document.getElementById("release"); 
                release.style.display = "none"

                const db = document.getElementById('duration-button');
                db.style.display = "none"
                const shb = document.getElementById('shorter-button');
                shb.style.display = "none"
                const lob = document.getElementById('longer-button');
                lob.style.display = "none"
                const stb = document.getElementById('start-button');
                stb.style.display = "none"

                toggle_fullscreen("on")

                start_screen = false;

            }

            socket.on('assign_user_id', function (msg) {
                user_id = msg;
            });

            function check_value_limits(circle) {
                circle.radius = Math.min(circle.radius, max_radius)
                circle.radius = Math.max(circle.radius, min_radius)
            }

            function update_inner_circle(circle, speed_multiplier) {
                circle.radius += radius_change * speed_multiplier;
                check_value_limits(circle)
            }


            function update_outer_circle(circle) {
                circle.outer_radius = circle.radius + circle.ring_width
            }


            function calculate_speed(last_event, circle) {
                if (last_event == "inhale") {
                    if (circle.radius > fast_radius_end) {
                        return speed_factor * inhale_speed_boost / out_of_bounds_slowdown;
                    }
                    else {
                        return speed_factor * inhale_speed_boost
                    }
                }
                if (last_event == "exhale") {
                    if (circle.radius < fast_radius_start) {
                        return -speed_factor / (out_of_bounds_slowdown * 1.25)
                    }
                    else {
                        return -speed_factor
                    }
                }
                if (last_event == "paused") {
                    return 0
                }
                
            }

            function animate_instructions() {
                const press = document.getElementById('press');
                const release = document.getElementById('release');

                const instructions = document.getElementById('instructions');
                const instructions2 = document.getElementById('instructions2');

                cur_time = (new Date).getTime()
                if ( ((cur_time - start_time) % 4000) < 2000) {
                    press.style.display = ""
                    release.style.display = "none"

                    instructions.style.display = ""
                    instructions2.style.display = "none"
                } else {
                    press.style.display = "none"
                    release.style.display = ""

                    instructions.style.display = "none"
                    instructions2.style.display = ""
                }
                

            }

            // Update the circle color on each frame
            function update() {
                speed_multiplier_client = calculate_speed(last_client_event, circle_client)
                update_inner_circle(circle_client, speed_multiplier_client)
                update_outer_circle(circle_client)
                
                if (start_screen) {
                    animate_instructions()
                }
            }

            function toggle_fullscreen(command) {
                if (command == "on") {
                    document.documentElement.requestFullscreen();
                    document.documentElement.setAttribute("fullscreen","");
                } else {
                    document.exitFullscreen();
                    document.documentElement.removeAttribute("fullscreen"); 
                }
            }

            const start_button = document.createElement("button");
            start_button.setAttribute('id','start-button');
            start_button.setAttribute('class','start-button noselect');
            start_button.textContent = 'start';
            start_button.addEventListener('click', start_session);
            start_button.style.display = ""
            document.body.appendChild(start_button);

            const shorter_button = document.createElement("button");
            shorter_button.setAttribute('id','shorter-button');
            shorter_button.setAttribute('class','shorter-button noselect');
            shorter_button.textContent = '-';
            shorter_button.addEventListener('click', go_shorter);
            shorter_button.style.display = ""
            document.body.appendChild(shorter_button);

            const longer_button = document.createElement("button");
            longer_button.setAttribute('id','longer-button');
            longer_button.setAttribute('class','longer-button noselect');
            longer_button.textContent = '+';
            longer_button.addEventListener('click', go_longer);
            longer_button.style.display = ""
            document.body.appendChild(longer_button);

            set_theme()

            function go_longer() {
                if (session_duration==30) {
                    session_duration = 60
                }
                if (session_duration==20) {
                    session_duration = 30
                }
                if (session_duration==10) {
                    session_duration = 20
                }
                if (session_duration==5) {
                    session_duration = 10
                }
                if (session_duration==2) {
                    session_duration = 5
                }
                if (session_duration==1) {
                    session_duration = 2
                }
                
                const duration = document.getElementById('duration-button');
                duration.textContent = session_duration.toString() + " min"
            }

            function go_shorter() {
                if (session_duration==2) {
                    session_duration = 1
                }
                if (session_duration==5) {
                    session_duration = 2
                }
                if (session_duration==10) {
                    session_duration = 5
                }
                if (session_duration==20) {
                    session_duration = 10
                }
                if (session_duration==30) {
                    session_duration = 20
                }
                if (session_duration==60) {
                    session_duration = 30
                }
                
                const duration = document.getElementById('duration-button');
                duration.textContent = session_duration.toString() + " min"
            }
            
            function set_theme() {
                const in_text1 = document.getElementById("instructions"); 
                const in_text2 = document.getElementById("instructions2"); 

                const db = document.getElementById('duration-button');
                const shb = document.getElementById('shorter-button');
                const lob = document.getElementById('longer-button');

                document.body.style.backgroundImage = `url("{{url_for('static', filename='dusk.png')}}")`;
                var circle_color1 = "rgb(11, 150, 230)";
                var circle_color2 = "white"

                in_text1.style.color = "lightcyan"
                in_text2.style.color = "lightcyan"

                db.style.color = "lightcyan" // "rgb(30, 60, 160)"
                shb.style.color = "lightcyan"
                lob.style.color = "lightcyan"
            }

            setInterval(update, 16);

            animate();
        });
</script>
<style>

    .shorter-button {
        position: absolute;
        top:  192px;
        right:  calc(50% + 45px + 0px);
        background: rgba(0,0,0,0);
        text-shadow: 0 0 10px lightblue;
        border: 1px rgb(0,0,0);
        border-radius: 100%;
        /* border-top-left-radius: 5px; */
        /* border-bottom-left-radius: 5px; */
        width:  40px;
        height:  40px;
        line-height: 0px;
        padding-bottom: 3px;
        color: navy;
        font-size: 22px;
        font-weight: bold;
        cursor:  pointer;
    }

    .shorter-button:hover {
        box-shadow:
        -5px 0px 15px 0px mediumblue;
        font-weight: 800;
    }

    .longer-button {
        position: absolute;
        top:  192px;
        right:  calc(50% - 85px + 0px);
        background: rgba(0,0,0,0);
        text-shadow: 0 0 10px lightblue;
        border: 1px rgb(0,0,0);
        border-radius: 100%;
        /* border-top-right-radius: 5px; */
        /* border-bottom-right-radius: 5px; */
        width:  40px;
        height:  40px;
        line-height: 20px;
        margin: auto;
        color: navy;
        font-size: 22px;
        box-sizing: border-box;
        cursor:  pointer;
    }

    .longer-button:hover {
        box-shadow:
        5px 0px 15px 0px mediumblue;
        font-weight: 700;
    } 
    

    .duration-button {
        position: absolute;
        top:  190px;
        right: calc(50% - 110px + 0px);
        /* background-image: linear-gradient(to right, lightcyan  0%, rgb(110, 160, 236)  100%); */
        background: rgba(0,0,0,0);
        text-shadow: 0 0 10px lightblue;
        width: 220px;
        height:  45px;
        border-radius: 5px;
        box-sizing: border-box;
        cursor:  pointer;
        text-align: center;
        line-height: 45px;
        font-size: 26px;
        text-decoration: none;
        font-family: poppins;
        font-weight: 400;
    }
         
    .start-button {
        position: absolute;
        top:  620px;
        left: calc(50% - 85px 0px);
        background-image: linear-gradient(to right, lightcyan  0%, rgb(110, 160, 236)  100%);
        border: none;
        text-align: center;
        color: rgb(30, 60, 160);            
        cursor:  pointer;
        border-radius: 7px;
        display: block;
        width:  170px;
        height:  45px;
        line-height: 42px;
        font-size: 28px;
        font-family: poppins;
        font-weight: 400;
    }

    .start-button:hover {
        font-weight: 500;
        box-shadow:
        7px -4px 30px 0px mediumblue,
        -4px 2px 20px 0px #0002;
    }



    .button-style {
        background: rgb(20, 20, 20);
        opacity: 0.92;
        border:  0px solid rgb(0, 0, 0);
        width:  200px;
        height:  30px;
        border-radius: 0px;
        box-sizing: border-box;
        cursor:  pointer;
        text-align: center;
        line-height: 30px;
        font-size: 14px;
        left:  33%;
        /* color: gold; */
        text-decoration: none;
        font-family: poppins;
    }

    .prompt {
        position: absolute; 
        left: 0px; 
        width: 100%; 
        top: 29.3%;
        text-align: center; 
        font-size: 18px; 
        font-weight: normal; 
        line-height: 30px; 
        font-family: Trebuchet MS; 
        color: midnightblue
    }

</style>
<style> 
.noselect {
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    -khtml-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
}
</style> 
<style>
    body {
      background-size: cover;
      background-repeat:no-repeat;
      background-attachment:fixed;
      background-position:center; 
    }
    br {
    line-height: 200px;
    }
</style>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">


<body>

        <hr id = "line1" style="position: absolute; top: 62px; left: calc(50% - 320px); width: 638px; text-align: center; font-size: 24px; opacity: 0.5; border-color: lightblue;">

        <p class="noselect" id = "header" style="position: absolute; top: 18px; left: 0; width: 100%; text-align: center; font-size: 26px; color: palegoldenrod; font-family: poppins">daily meditation</p>


        <p class="noselect" id="instructions" style="position: absolute; top: 305px; left: calc(50% - 183px); width: 366px; text-align: center; font-size: 28px; line-height: 18px; font-family: poppins; font-weight: 400;text-shadow: 0 0 10px lightblue"><a style = "font-weight:500">Instructions:</a><br><br>Press as you inhale</p>

        <p class="noselect" id="instructions2" style="position: absolute; top: 305px; left: calc(50% - 183px); width: 366px; text-align: center; font-size: 28px; line-height: 18px; font-family: poppins; font-weight: 400;text-shadow: 0 0 10px lightblue; display: none"><a style = "font-weight:500">Instructions:</a><br><br>Release as you exhale</p>

        <p class="noselect" id="instructions2" style="position: absolute; top: 130px; left: calc(50% - 233px); width: 466px; text-align: center; font-size: 26px; line-height: 18px; color: lightcyan; font-family: poppins; font-weight: 500;text-shadow: 0 0 10px lightblue">How long do you want to meditate?</p>
        
        <img id="press" src="{{url_for('static', filename='press.png')}}" style=" position: absolute; top: 415px; left: calc(50% - 100px); width: 160px; height: 75px;" alt="inhale" />

        <img id="release" src="{{url_for('static', filename='release.png')}}" style=" position: absolute; top: 415px; left: calc(50% - 100px); width: 160px; height: 75px; display: none;" alt="exhale" />
    
        <p class="noselect" id="encourage" style=" position: absolute; top: 390px; left: 180px; width: 20em; text-align: right; font-size: 22px; line-height: 30px; font-family: poppins; color: skyblue"></p>

        <p class="noselect prompt" id="breathe_in"></p> 

        <p class="noselect prompt" id="breathe_out"></p>

    <a id = "duration-button" class='duration-button noselect' style = "display: ''">2 min</a>
    

</body>

</html>