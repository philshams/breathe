<!DOCTYPE HTML>
<html>

<head>
    <title>Flask-SocketIO Test</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"
        integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg=="
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.0.4/socket.io.js"
        integrity="sha512-aMGMvNYu8Ue4G+fHa359jcPb1u+ytAF+P2SCb+PxrjCdO3n3ZTxJ30zuH39rimUggmTwmh2u7wvQsDTHESnmfQ=="
        crossorigin="anonymous"></script>
    <script type="text/javascript" charset="utf-8">
        $(document).ready(function () {
            var key_code = 32;
            function getRandomInt(max) {
                return Math.floor(Math.random() * max);
            }
            var user_id = getRandomInt(100000000000);
            $('#user_id').append(user_id)



            // Connect to the Socket.IO server.
            // The connection URL has the following format, relative to the current page:
            //     http[s]://<domain>:<port>[/<namespace>]
            var socket = io("/", 
            {
                reconnectionDelayMax: 10000, 
                // this is used to keep track of which user has joined
                auth: { id: user_id }
            });
            console.log(socket)


            // keypress thingy
            document.addEventListener("keydown", function (event) {
                if (event.keyCode == key_code) {
                    event.preventDefault();
                    socket.emit('client_keydown', { data: user_id });
                }
            });

            // keypress thingy
            document.addEventListener("keyup", function (event) {
            if (event.keyCode == key_code) {
                socket.emit('client_keyup', { data: user_id });
            }
            });

            window.onbeforeunload = function () {
                // socket.emit('client_disconnecting', {'username':localStorage.getItem('username')});
                socket.emit('leave', { data: user_id });
            }


            // loop through and update count divs
            socket.on('update_state', function (msg) {
                $('#log').append("<br>" + JSON.stringify(msg));
            });

            // loop through and update count divs
            socket.on('user_connection', function (msg) {
                $('#log').append("<br>" + JSON.stringify(msg));
            });
            
            // Event handler for server sent data.
            // The callback function is invoked whenever the server emits data
            // to the client. The data is then displayed in the "Received"
            // section of the page.
            socket.on('my_response', function (msg, cb) {
                $('#log').append('<br>' + $('<div/>').text('Received #' + msg.count + ': ' + msg.data + " (" + (new Date()).toLocaleTimeString() + ")").html());
                if (cb)
                    cb();
            });


        });
    </script>
</head>

<body>
    <h2>User: <span id="user_id"></span></h2>
    <p>Average ping/pong latency: <b><span id="ping-pong"></span>ms</b></p>
    <h2>Receive:</h2>
    <div id="log"></div>
</body>

</html>