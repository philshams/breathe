<!DOCTYPE HTML>
<html lang="en">
<head>
    <title>2-min meditation</title>
    <meta property="og:title" content="{{ meta_title or '2-min meditation' }}">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <style>
        body {
            margin: 0 !important;
            padding: 0 !important;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #000000;
            overflow-y: hidden;
            overflow-x: hidden;
        }

        #container {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #meditationCanvas {
            display: block;
        }
    </style>
    <link rel="icon" href="{{url_for('static', filename='moonicon.png')}}">
</head>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"
        integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg=="
        crossorigin="anonymous">
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.0.4/socket.io.js"
        integrity="sha512-aMGMvNYu8Ue4G+fHa359jcPb1u+ytAF+P2SCb+PxrjCdO3n3ZTxJ30zuH39rimUggmTwmh2u7wvQsDTHESnmfQ=="
        crossorigin="anonymous">
</script>
<canvas class = "noselect" id="meditationCanvas"></canvas>
<script type="text/javascript" charset="utf-8" > // 
        $(document).ready(function () {

            const meditationCanvas = document.getElementById('meditationCanvas');
            meditationCanvas.width = window.innerWidth;
            meditationCanvas.height = window.innerHeight;
            const ctx = meditationCanvas.getContext('2d');

            const radius_scale = 0.5;
            var screen_size_factor = (window.innerHeight / 2200) / 0.5;
            const min_radius = 75 * radius_scale;
            var start_radius = 100 * radius_scale;
            const max_radius = 300 * radius_scale;

            const max_ring_width = 1200  * radius_scale
            const radius_change = 0.6 * radius_scale;

            const max_speed = 2.0;
            const max_speed_exhale = 1.2;
            const acceleration_init = 0.06;

            var speed_client = 0;
            var speed_server = 0;
            var counter = 0;

            var ring_color = "rgba(235,235,245"
            const circle_color = "white"

            var session_duration = 2;
            var start_time = 0;
            var press_time = 0;

            var joinSuccessReceived = false;
            var tapped = false;
            var minute_warning_given = false;
            var partner_prompt_shown = false;

            var fullscreen = true;
            var fullscreen_factor = 1;

            user_id = 0;

            var x_pos = meditationCanvas.width / 2;

            var circle_client = {
                x: x_pos,
                y: 0,
                radius: start_radius,
                ring_width: max_ring_width,
            };

            var circle_server = {
                x: x_pos,
                y: 0,
                radius: start_radius,
                ring_width: max_ring_width,
            };

            var num_breaths = 0;
            var num_breaths_at_marker = 9999999;
            var num_active;
            var last_event = 'paused';
            var last_event_server = 'paused';
            var time_in_session = 0;
            var time_in_session_partner = 0;
            var first_breath_received = false;
            var first_breath_happened = false;
            var enjoy_shown = false;

            var isHost = true;

            var inhale_time = 0;
            var exhale_time = 0;
            var hold_time = 0;

            var mode = 'solo';
            var partner_id = 0

            var start_screen = true;
            var end_screen = false;

            function getOS() {
                const userAgent = window.navigator.userAgent,
                    platform = window.navigator?.userAgentData?.platform || window.navigator.platform,
                    macosPlatforms = ['macOS', 'Macintosh', 'MacIntel', 'MacPPC', 'Mac68K'],
                    windowsPlatforms = ['Win32', 'Win64', 'Windows', 'WinCE'],
                    iosPlatforms = ['iPhone', 'iPad', 'iPod'];
                let os = null;

                if (macosPlatforms.indexOf(platform) !== -1) {
                    os = 'Mac OS';
                } else if (iosPlatforms.indexOf(platform) !== -1) {
                    os = 'iOS';
                } else if (windowsPlatforms.indexOf(platform) !== -1) {
                    os = 'Windows';
                } else if (/Android/.test(userAgent)) {
                    os = 'Android';
                } else if (/Linux/.test(platform)) {
                    os = 'Linux';
                }

                return os;
            }
            const os = getOS()
            console.log(os)

            // Connect to the Socket.IO server.
            var socket = io("/");
            // console.log(socket)

            function resizeCanvas() {
                meditationCanvas.width = window.innerWidth;
                meditationCanvas.height = window.innerHeight;
                x_pos = meditationCanvas.width / 2;
                if (mode == "solo") {
                    screen_size_factor = 1.2 * (window.innerHeight / 2200) / 0.5;
                } else {
                    screen_size_factor = (window.innerHeight / 2200) / 0.5;
                }
                
                circle_client.x = x_pos;
                circle_server.x = x_pos;
            }

            window.onpopstate = function(event) {
                if(event) {
                    location.reload()
                }
            }

            window.addEventListener('resize', resizeCanvas);    

            function createOuterCircle(circle){

                const gradient2 = ctx.createRadialGradient(circle.x, circle.y - circle.radius * screen_size_factor * 2, 0, circle.x, circle.y - circle.radius * screen_size_factor * 2, (max_ring_width) * (circle.radius / 150)**2.5 * screen_size_factor);

                alpha = Math.max(0.002, Math.min(0.2, 0.055 * (circle.radius / 40 - 1.0)))*1.5

                gradient2.addColorStop(0, ring_color + ', ' + alpha.toString() + ')');
                gradient2.addColorStop(1, ring_color + ', 0)');
                return gradient2;
    
            }

            function drawOuterCircle(circle) {
                const gradient = createOuterCircle(circle);
                ctx.beginPath();
                if (mode =="solo") {
                    ctx.arc(circle.x, circle.y - circle.radius * screen_size_factor * 2, (circle.radius * 40) * screen_size_factor, 0, 2 * Math.PI);
                } else {
                    ctx.arc(circle.x, circle.y - circle.radius * screen_size_factor * 2, (max_ring_width) * (circle.radius / 150)**2.5 * screen_size_factor, 0, 2 * Math.PI);
                }
                ctx.fillStyle = gradient;
                ctx.fill();
            }

            function adjust_image(image, circle, translation_factor, scale_factor = 1) {
                image.style.width = (2 * circle.radius * screen_size_factor * scale_factor).toString() + "px"
                image.style.height = (2 * circle.radius * screen_size_factor * scale_factor).toString() + "px"
                if (mode == "solo") {
                    image.style.left = "calc(50% - " + (circle.radius * screen_size_factor).toString() + "px)"
                }
                if (mode == "pair") {
                    if (Math.sign(translation_factor) > 0) {
                        image.style.left = "calc(50% - " + (circle.radius * screen_size_factor + translation_factor * start_radius * screen_size_factor + Math.sign(translation_factor) * 1 /4 * circle.radius).toString() + "px)"
                        circle.x = x_pos - translation_factor * start_radius * screen_size_factor - Math.sign(translation_factor) * 1 /4 * circle.radius
                    } else {
                        image.style.left = "calc(50% - " + (circle.radius * screen_size_factor + translation_factor * start_radius * screen_size_factor).toString() + "px)"
                        circle.x = x_pos - translation_factor * start_radius * screen_size_factor
                    }
                }
                image.style.top = (circle.y - (2 + scale_factor) * circle.radius * screen_size_factor).toString() + "px"
            }

            function drawRects() {
                const meditationCanvas = document.getElementById('meditationCanvas');
                meditationCanvas.width = window.innerWidth;
                meditationCanvas.height = window.innerHeight;
                const ctx = meditationCanvas.getContext('2d');
                ctx.fillStyle = "rgba(235,200,235,.05)";
                ctx.fillRect(0, 0, window.innerWidth / 2 - window.innerHeight / 3, window.innerHeight)
                ctx.fillRect(window.innerWidth / 2 + window.innerHeight / 3, 0, window.innerWidth / 2 - window.innerHeight / 3, window.innerHeight)
            }

            function animate() {
                ctx.clearRect(0, 0, meditationCanvas.width, meditationCanvas.height);

                if (!start_screen) {
                    
                    if (mode == "solo") {
                        const moon_client = document.getElementById("moon_client");
                        adjust_image(moon_client, circle_client)
                        drawOuterCircle(circle_client);
                    }

                    if (mode == "pair") {
                        const moon_partner = document.getElementById("moon_partner");
                        const moon_partner2 = document.getElementById("moon_partner2");
                        const moon_client = document.getElementById("moon_client");
                        adjust_image(moon_client, circle_client, 1.75, 1.0)
                        adjust_image(moon_partner, circle_server, -1.75, 1.1)
                        adjust_image(moon_partner2, circle_server, -1.75, 1.1)

                        drawOuterCircle(circle_client);
                        drawOuterCircle(circle_server);
                    }
                    
                }

                if (start_screen) {
                    drawRects()
                }

                requestAnimationFrame(animate);
            }

            function display_prompt() {
                const instructions2 = document.getElementById("instructions2");
                press_time = (new Date).getTime()
                instructions2.style.display = ""
                instructions2.style.opacity = 1.0
                return (new Date).getTime()
            }

            function end_session() {
                const instructions2 = document.getElementById("instructions2");
                instructions2.style.display = ""
                instructions2.style.opacity = 1.0
                instructions2.textContent = "Meditation complete"
                const again_button = document.getElementById('again-button');
                again_button.style.display = ""
                document.getElementById("instructionsPanel").style.display = "none";
                // toggle_fullscreen("off")
                end_screen = true;
                if (mode == "pair"){
                    socket.emit('leave_room_complete');
                }
            }

            function partner_prompt() {
                if (partner_id != 0 && !partner_prompt_shown){
                    const instructions2 = document.getElementById("instructions2");
                    display_prompt()
                    if (isHost) {
                        instructions2.textContent = "Someone has joined you."
                    } else {
                        instructions2.textContent = "Your breathing partner is here."
                    }
                    instructions2.style.fontSize = "3.1vh"
                    partner_prompt_shown = true;
                }
                const moon_partner = document.getElementById("moon_partner"); 
                moon_partner.style.display = ""
                const moon_partner2 = document.getElementById("moon_partner2"); 
                moon_partner2.style.display = "none"
            }

            function verbal_prompt(source="client") {
                const instructions2 = document.getElementById("instructions2");
                
                if (num_breaths >= 3 && !end_screen && source=="client" && (session_duration - time_in_session) > 1.5) {
                    if (instructions2.style.display == "none" && !enjoy_shown) {
                        display_prompt()
                        instructions2.textContent = "Enjoy your 2-minute meditation!"
                        enjoy_shown = true
                    }
                }

            }

            function calculate_time_in_session() {
                if (first_breath_happened && (first_breath_received || mode == "solo")){
                    time_in_session = ((new Date).getTime() - start_time)  / 1000 / 60
                
                }
                // console.log(time_in_session) 
            }

            function key_down_response(event) {
                if (event && event.target && event.target.closest && event.target.closest('#roomLink')) return;

                if (!last_event.includes('inhale') && !start_screen) {
                    
                    if (mode!="pair" || first_breath_received) {
                        num_breaths = num_breaths + 1;
                    }
                    
                    last_event = 'inhale'  

                    if (!first_breath_happened) {
                        first_breath_happened = true;
                        if (mode == "solo") {
                        start_time = Math.max((new Date).getTime(), start_time);
                        }

                        if (first_breath_received && mode == "pair") {
                        start_time = Math.max((new Date).getTime(), start_time);
                        }
                    }
                    calculate_time_in_session()

                    const roomId = "{{ room_id }}" || window.location.pathname.split("/").pop();
                    socket.emit("client_keydown", circle_client.radius, time_in_session, roomId);
                    
                    verbal_prompt()

                    
                    
                }
            }

            function key_up_response(event) {
                if (event && event.target && event.target.closest && event.target.closest('#roomLink')) return;

                if (!last_event.includes('exhale') && !start_screen) {
                    const roomId = "{{ room_id }}" || window.location.pathname.split("/").pop();
                    socket.emit("client_keyup", circle_client.radius, time_in_session, roomId);
                    if (mode!="pair" || first_breath_received) {
                        num_breaths = num_breaths + 1;
                    }
                    if ((num_breaths == 2 || num_breaths == 4) && mode == "solo") {
                        verbal_prompt()
                    }
                    
                    last_event = 'exhale'   
                }
            }

            // Add event listener for the "keydown" event on the document object
            document.addEventListener('keydown', (event) => {
                if (event.code === 'Space' || event.code === 'Tab' || event.altKey) {
                    // Prevent default behavior of the spacebar key
                    event.preventDefault();
                }
                if (event.code === 'Escape') {
                    toggle_fullscreen("off")
                } else if (event.ctrlKey || event.altKey || event.code === 'Tab' || event.key.toLowerCase() === 'c') {
                    return;
                } else {
                    key_down_response(event)
                }
                if (!start_screen && !end_screen){
                    // Use the room_id from Flask OR from the URL path
                    const roomId = "{{ room_id }}" || roomMatch[1];
                    socket.emit('join_room_lite', { room: roomId });
                }

            });

            // Add event listener for the "keyup" event on the document object
            document.addEventListener('keyup', (event) => {
                key_up_response(event)
            });

            // Add event listener for the "keydown" event on the document object
            document.addEventListener('mousedown', (event) => {
                const instructions2 = document.getElementById("instructions2");
                if (!start_screen && !end_screen && !instructions2.textContent.includes("your breathing partner go to")) {
                    event.stopPropagation();
                    event.preventDefault();
                }
                key_down_response(event)
            });

            // Add event listener for the "keyup" event on the document object
            document.addEventListener('mouseup', (event) => {
                const instructions2 = document.getElementById("instructions2");
                if (!start_screen && !end_screen && !instructions2.textContent.includes("your breathing partner go to")) {
                    event.stopPropagation();
                    event.preventDefault();
                }
                key_up_response(event)
            });

            // function doubleClickOff() {
            //     tapped = false;               
            // }

            // function doubleClick() {
            //     if (tapped) {
            //         toggle_fullscreen("toggle")
            //         tapped = false;
            //     } else {
            //         tapped = true;
            //     }
            // }
            // Add event listener for the "keydown" event on the document object
            document.addEventListener('touchstart', (event) => {
                const instructions2 = document.getElementById("instructions2");
                if (!start_screen && !end_screen && !instructions2.textContent.includes("your breathing partner go to")) {
                    event.stopPropagation();
                    event.preventDefault();
                }
                key_down_response(event)
            });

            // Add event listener for the "keyup" event on the document object
            document.addEventListener('touchend', (event) => {
                const instructions2 = document.getElementById("instructions2");
                if (!start_screen && !end_screen && !instructions2.textContent.includes("your breathing partner go to")) {
                    // doubleClick()
                    // setTimeout(doubleClickOff, 300);
                    event.stopPropagation();
                    event.preventDefault();
                }
                key_up_response(event)
            });

            // Add event listener for the "keyup" event on the document object
            // document.addEventListener('dblclick', (event) => {
            //     if (!start_screen) {
            //         toggle_fullscreen("toggle")
            //     }
            // });

            window.onbeforeunload = function () {
                socket.emit('leave');
            }

            socket.on('assign_user_id', function (msg) {
                user_id = msg;
                console.log("ID: " + msg.toString())
            });

            socket.on('end_session', function (msg) {
                end_session()
            });

            socket.on('assign_partner', function (msg) {
                partner_id = msg;
                partner_prompt()
                console.log("partner ID: " + msg.toString())
            });

            socket.on('partner_state', function (radius, direction, time_in_session_received) {
                const moon_partner = document.getElementById("moon_partner"); 
                if (moon_partner.style.display = "none") {
                    moon_partner.style.display = ""
                    const moon_partner2 = document.getElementById("moon_partner2"); 
                    moon_partner2.style.display = "none"
                }
                
                if (!first_breath_received) {
                    partner_prompt()
                    first_breath_received = true
                    circle_server.radius = radius
                    if (first_breath_happened && mode == "pair") {
                        start_time = Math.max((new Date).getTime(), start_time);
                    }
                    
                }
                if (Math.abs(radius - circle_server.radius) > 30) {
                    circle_server.radius = radius
                }
                last_event_server = direction
                time_in_session_partner = time_in_session_received
                calculate_time_in_session()
                verbal_prompt("server")
            });

            socket.on('reset_partner', function () {
                circle_server.radius = start_radius
                last_event_server = 'paused'
                const moon_partner = document.getElementById("moon_partner"); 
                moon_partner.style.display = "none"
                const moon_partner2 = document.getElementById("moon_partner2"); 
                moon_partner2.style.display = ""
            });

        socket.on('room_full', function(data){
            window.location.href = '/'; // redirect to home
            alert(data.msg);
        });



            function start_session() {
                const instructions = document.getElementById("instructions"); 
                instructions.style.display = "none"

                const header = document.getElementById("header"); 
                header.style.display = "none"

                const line1 = document.getElementById("line1"); 
                line1.style.display = "none"

                // const stb = document.getElementById('start-button');
                // stb.style.display = "none"

                const gtb = document.getElementById('guided-button');
                gtb.style.display = "none"

                const ttb = document.getElementById('together-button');
                ttb.style.display = "none"

                const moon_client = document.getElementById("moon_client"); 
                moon_client.style.display = ""

                // Show panel
                document.getElementById("instructionsPanel").style.display = "block";

                // if (os!="iOS") {
                //     toggle_fullscreen("on")
                // }
                
                start_screen = false;

            }

            function start_session_solo() {

                resizeCanvas()
                start_session()
                history.pushState({}, "", "solo");
                mode = "solo"

                // const instructions4 = document.getElementById("instructions4"); 
                // instructions4.style.display = ""

                const instructions2 = document.getElementById("instructions2");
                instructions2.textContent = "Welcome to Breathing Moon!"
                instructions2.style.display = ""

            }


            function start_session_pair() {
                // Detect if weâ€™re already in a /room/<id> URL
                const path = window.location.pathname;
                const roomMatch = path.match(/\/room\/([a-z0-9]+)/);

                // If no room_id in template and not already in /room/<id>, make one
                if (!"{{ room_id }}" && !roomMatch) {
                    const newRoom = Math.random().toString(36).substring(2, 6);
                    window.location.href = `/room/${newRoom}`;
                    return;
                }

                // Use the room_id from Flask OR from the URL path
                const roomId = "{{ room_id }}" || roomMatch[1];
                socket.emit('join_room_event', { room: roomId });

                setTimeout(function() {
                    if (!joinSuccessReceived) {
                        window.location.reload();
                    }
                }, 2000);
                
                // Now start the visual/session setup
                start_session();

                const moon_partner2 = document.getElementById("moon_partner2"); 
                moon_partner2.style.display = "";
                // const instructions4 = document.getElementById("instructions4"); 
                // instructions4.style.display = "";
                circle_client.radius = start_radius * 0.9;
                circle_server.radius = start_radius * 0.9;
                mode = "pair";
            }

            socket.on('join_success', function() {
                joinSuccessReceived = true;
            });

            socket.on('assign_host', function (msg) {
                isHost = msg;
                if (isHost) {
                    const instructions2 = document.getElementById("instructions2"); 
                    instructions2.style.display = ""
                }
            });

            socket.on('assign_user_id', function (msg) {
                user_id = msg;
            });

            function check_value_limits(circle, speed) {
                if (circle.radius > max_radius || circle.radius < min_radius) {
                    speed = 0
                }
                circle.radius = Math.min(circle.radius, max_radius)
                circle.radius = Math.max(circle.radius, min_radius)
                return speed
            }

            function update_inner_circle(circle, speed) {
                circle.radius += radius_change * speed;
            }

            function update_last_event(speed, last_event) {
                if (speed > (0.9*max_speed) && last_event == "inhale") {
                    counter = 0;
                    return "inhale (phase 2)"
                }

                return last_event
            }


            function calculate_speed(last_event, circle, speed) {

                if (last_event == "inhale") {
                        if (speed < 0) {
                            return speed + acceleration_init * 1
                        }

                        return speed + acceleration_init * Math.abs(1 - speed / max_speed)
                }
                if (last_event == "exhale") {
                        if (speed > 0) {
                            return Math.min(-0.5, -max_speed_exhale * Math.min(1, circle.radius / 90))
                        }
                        if (circle.radius > 77){
                            return -max_speed_exhale
                        }
                        return Math.min(-0.08, speed * .987)
                }

                if (last_event.includes("phase 2") && counter < 10){
                    counter = counter + 1;
                    return speed
                }

                if (last_event == "inhale (phase 2)") {
                        return Math.max(0.12, speed*.982)
                }

                if (last_event == "paused") {
                    return 0
                }
                
            }

            function update_text() {
                const text = document.getElementById("instructions2");
                if (text.style.display == "" && ((new Date).getTime() - press_time) > 2000 && !end_screen && ((num_breaths > 2 && mode=="solo") || (num_breaths > 0 && mode == "pair")) ) {
                    text.style.opacity = text.style.opacity - 0.003
                    if (text.style.opacity < 0.01) {
                        text.style.display = "none"
                    }
                }
            }

            function update_position() {
                if (fullscreen && !document.fullscreenElement) {
                    fullscreen = false;
                    fullscreen_factor = 1.04
                }
                if (!fullscreen && document.fullscreenElement) {
                    fullscreen = true;
                    fullscreen_factor = 1.
                }

                if (mode == "solo") {
                    circle_client.y = fullscreen_factor * window.innerHeight * 0.8 - 2.2 * circle_client.radius * screen_size_factor / fullscreen_factor
                }

                if (mode == "pair") {
                    circle_client.y = fullscreen_factor * window.innerHeight * 0.76 - 2.2 * circle_client.radius * screen_size_factor / fullscreen_factor

                    circle_server.y = fullscreen_factor * window.innerHeight * 0.76 - 2.2 * circle_server.radius * screen_size_factor / fullscreen_factor
                }
            }


            // Update the circle color on each frame
            function update() {

                if (!end_screen && !start_screen) {
                    last_event = update_last_event(speed_client, last_event)
                    speed_client = calculate_speed(last_event, circle_client, speed_client)
                    speed_client = Math.max(speed_client, -max_speed)
                    speed_client = Math.min(speed_client, max_speed)
                    
                    update_inner_circle(circle_client, speed_client)
                    speed_client = check_value_limits(circle_client, speed_client)
                    update_text()

                    if (mode=="pair"){
                        last_event_server = update_last_event(speed_server, last_event_server)
                        speed_server = calculate_speed(last_event_server, circle_server, speed_server)
                        speed_server = Math.max(speed_server, -max_speed)
                        speed_server = Math.min(speed_server, max_speed)
                    
                        update_inner_circle(circle_server, speed_server)
                        speed_server = check_value_limits(circle_server, speed_server)
                    }

                    calculate_time_in_session()
                    if ((session_duration - time_in_session) <= 1.0 && !minute_warning_given) {
                        display_prompt()
                        instructions2.textContent = "One minute left"
                        minute_warning_given = true;
                    }
                    if (time_in_session > session_duration && !end_screen) {
                        end_session()
                    }
                }
                update_position()
                
            }

            function toggle_fullscreen(command) {
                if (command == "on" || (command != "off" && !document.fullscreenElement)) {
                    document.documentElement.requestFullscreen();
                    document.documentElement.setAttribute("fullscreen","")

                } else if (document.fullscreenElement){
                    document.exitFullscreen();
                    document.documentElement.removeAttribute("fullscreen"); 
                }
            }
            const again_button = document.createElement("button");
            again_button.setAttribute('id','again-button');
            again_button.setAttribute('class','again-button noselect');
            again_button.textContent = 'Go again';
            document.body.appendChild(again_button);
            again_button.style.display = "none"
            again_button.addEventListener('click', () => {
                console.log('BUTTON PRESSED')
                window.location.href = '/'; // go to homepage
            });

            const together_button = document.createElement("button");
            together_button.setAttribute('id','together-button');
            together_button.setAttribute('class','together-button noselect');
            together_button.textContent = 'host a meditation';
            together_button.addEventListener('click', start_session_pair);
            together_button.style.display = ""
            document.body.appendChild(together_button);

            const guided_button = document.createElement("button");
            guided_button.setAttribute('id','guided-button');
            guided_button.setAttribute('class','guided-button noselect');
            guided_button.textContent = 'solo meditation';
            guided_button.addEventListener('click', start_session_solo);
            guided_button.style.display = ""
            document.body.appendChild(guided_button);

            const closeBtn = document.getElementById("closeInstructions");
            ["mousedown", "touchstart", "mouseup", "touchend"].forEach(evt => {
                closeBtn.addEventListener(evt, function(event) {
                    event.stopPropagation(); // prevents moon detection
                });
            });

            const closePnl = document.getElementById("instructionsPanel");
            ["mousedown", "touchstart", "mouseup", "touchend"].forEach(evt => {
                closePnl.addEventListener(evt, function(event) {
                    event.stopPropagation(); // prevents moon detection
                });
            });

            // Rejoin room when returning to page (Safari + other browsers)
            window.addEventListener('pageshow', function () {
            if (path.includes("/room/")) {
                const roomId = path.split("/").pop();
                socket.emit('join_room_event', { room: roomId });
            }
            });

            // rejoin room if backgrounding removes it
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden) {
                    // Page became visible again - rejoin the room
                    if (path.includes("/room/")) {
                        const roomId = path.split("/").pop();
                        socket.emit('join_room_event', {room: roomId});
                    }
                }
            });

            // Close button
            document.getElementById("closeInstructions").onclick = function() {
                document.getElementById("instructionsPanel").style.display = "none";
            }
            document.getElementById("instructionsPanel").onclick = function() {
                document.getElementById("instructionsPanel").style.display = "none";
            }


            document.body.style.backgroundImage = `url("{{url_for('static', filename='duskyIII.jpg')}}")`;

            setInterval(update, 16);

            animate();

            const path = window.location.pathname;
            if (path.includes("/room/")) {
                const roomId = path.split("/").pop();
                const linkEl = document.getElementById("roomLink");

                const isMobile = /Mobi|Android/i.test(navigator.userAgent);

                if (linkEl && isHost) {
                    linkEl.textContent = window.location.href;

                    if (!isMobile) {
                        // Desktop: copy on click
                        const copyToClipboard = (e) => {
                            e.preventDefault();
                            e.stopImmediatePropagation();

                            const textarea = document.createElement('textarea');
                            textarea.value = window.location.href;
                            textarea.style.position = 'fixed';
                            textarea.style.opacity = '0';
                            document.body.appendChild(textarea);
                            textarea.select();
                            document.execCommand('copy');
                            document.body.removeChild(textarea);

                            const prev = linkEl.textContent;
                            linkEl.textContent = "Copied!";
                            setTimeout(() => (linkEl.textContent = prev), 1500);
                        };

                        const wrapper = document.createElement('div');
                        wrapper.style.display = 'inline-block';
                        wrapper.style.padding = '3em 4em';
                        wrapper.style.margin = '-3em -4em';
                        wrapper.style.cursor = 'pointer';
                        linkEl.parentNode.insertBefore(wrapper, linkEl);
                        wrapper.appendChild(linkEl);

                        wrapper.addEventListener("mousedown", copyToClipboard, true);
                        wrapper.addEventListener("touchstart", copyToClipboard, true);
                    } else {
                        // Mobile: just selectable text
                        linkEl.style.userSelect = 'text';
                        linkEl.style.cursor = 'text';
                        ['mousedown', 'mouseup', 'touchstart', 'touchend'].forEach(evt => {
                            linkEl.addEventListener(evt, e => e.stopPropagation());
                        });
                    }
                } else if (!isHost) {
                    const instructions2 = document.getElementById("instructions2");
                    instructions2.style.display = "none";
                }
                start_session_pair();
            } else if (path.endsWith("/solo")) {
                start_session_solo();
            }


        });

</script>
<style>


    .together-button {
        position: absolute;
        top:  37.45vh;
        left: calc(50% - 14.5vh);
        background-image: linear-gradient(to right, rgb(210,210,255) 0%, rgb(200,225,255) 90%);
        border: none;
        opacity: 0.98;
        text-align: center;
        color: rgb(40,60,150);
        /* color: royalblue;  */
        cursor:  pointer;
        border-radius: 1px;
        border-bottom-left-radius: 3px;
        border-bottom-right-radius: 3px;
        display: block;
        width:  29vh;
        height:  4.2vh;
        line-height: 0px;
        padding-bottom: 2px;
        font-size: 2.4vh;
        font-family: poppins;
        font-weight: 500;
        box-shadow:
        0px 0px 2px 0px lightcyan;
    }

    .together-button:hover {
        box-shadow:
        0px 0px 5px 0px lightcyan;
        opacity: 1.0;
    }

    .guided-button {
        position: absolute;
        top:  32.99vh;
        left: calc(50% - 14.5vh);
        background-image: linear-gradient(to right, rgb(210,210,255) 0%, rgb(200,225,255) 90%);
        border: none;
        opacity: 0.98;
        text-align: center;
        color: rgb(40,60,150);
        /* color: royalblue;  */
        cursor:  pointer;
        border-radius: 1px;
        border-top-left-radius: 3px;
        border-top-right-radius: 3px;
        display: block;
        width:  29vh;
        height:  4.3vh;
        line-height: 0px;
        padding-bottom: 2px;
        font-size: 2.4vh;
        font-family: poppins;
        font-weight: 500;
        box-shadow:
        0px 0px 2px 0px lightcyan;
    }

    .guided-button:hover {
        box-shadow:
        0px 0px 5px 0px lightcyan;
        opacity: 1.0;
    }

    .again-button {
    position: absolute;
    bottom:  18vh;
    left: calc(50% - 9vh);
    background-image: linear-gradient(to right, rgb(210,210,255) 0%, rgb(200,225,255) 90%);
    border: none;
    opacity: 0.98;
    text-align: center;
    color: rgb(40,60,150);
    /* color: royalblue;  */
    cursor:  pointer;
    border-radius: 3px;
    display: block;
    width:  18vh;
    height:  4.2vh;
    /* line-height: 0px; */
    /* padding-bottom: 2px; */
    font-size: 2.5vh;
    font-family: poppins;
    font-weight: 500;
    box-shadow:
    0px 0px 2px 0px lightcyan;
    }

    .again-button:hover {
        box-shadow:
        0px 0px 5px 0px lightcyan;
        opacity: 1.0;
    }

    .hr-style {
    border: 0;
    height: 0.2vh;
    background-image: linear-gradient(to right, rgb(255,255,255, 0.2) 0%, rgba(240,255,255, 0.5) 12%, rgba(240,255,255, 0.8) 40%, rgba(230,220,255, 0.8) 50%,rgba(230,220,255, 0.8) 60%, rgba(247,242,255, 0.5) 88%, rgba(255,255,255, 0.2) 100%);
}

</style>
<style> 
.noselect {
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    -khtml-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
}
.grad {
    background-image: linear-gradient(to right, rgb(255,220,255) 0%, rgb(230,252,255) 90%);
    color: transparent;
    background-clip: text;
}
.grad2 {
    background-image: linear-gradient(to right, rgb(220,195,255) 10%, rgb(210,250,255) 90%);
    color: transparent;
    background-clip: text;
}
</style> 
<style>
    body {
      background-size: cover;
      background-repeat:no-repeat;
      background-attachment:fixed;
      background-position:center; 
    }
    br {
    line-height: 200px;
    }
</style>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">


<body>

        <hr id = "line1" class="hr-style" style="position: absolute; top: 8.46vh; left: calc(50% - 4.3em); font-size: 5vh; width: 8.6em; text-align: center;">

        <p class="noselect grad2" id = "header" style="position: absolute; left: calc(50%-5em); top: 0vh; width: 10em; text-align: center; font-size: 5.15vh; font-weight: 600; font-family: poppins;">breathing moon</p>

        <img class="noselect" id="moon_partner" src="{{url_for('static', filename='titanII.png')}}" style=" position: absolute; top: 220px; width: 200px; text-align: center; height: auto; display: none; pointer-events: none;" alt="moon_partner" />

        <img class="noselect" id="moon_partner2" src="{{url_for('static', filename='titanII2.png')}}" style=" position: absolute; top: 220px; width: 200px; text-align: center; height: auto; display: none; pointer-events: none;" alt="No one else is in the breathing room" />

        <img class="noselect" id="moon_client" src="{{url_for('static', filename='moonIII.png')}}" style=" position: absolute; top: 220px; width: 200px; text-align: center; height: auto; display: none; pointer-events: none;" alt="moon_client" />

        <p class="noselect grad" id="instructions" style="position: absolute; top: 12vh; left: calc(50% - 8.6em); width: 17.2em; text-align: center; font-size: 2.2vh; line-height: 3.2vh; font-family: poppins; font-weight: 400;">Take a moment to reset.</p>

        <div id="instructionsPanel" style="
            position: absolute; 
            bottom: 12vh; 
            left: 50%; 
            transform: translateX(-50%);
            width: 18em; 
            background: rgba(0, 0, 0, 0.4); 
            color: white; 
            padding: 0.1em 0.4em 0.1em 1.5em;
            border-radius: 0.5em;
            display: none;
            font-family: poppins;
            font-size: 2.0vh;
            line-height: 3.2vh;
            cursor: pointer; 
        ">
            <span id="closeInstructions" class="noselect" style="
                position: absolute; 
                top: 0.25em; 
                right: 0.35em; 
                cursor: pointer; 
                font-size: 1.5em;
            ">&times;</span>
            <p class="noselect grad" style="text-align: left; font-weight: 400;">
                <a style="font-weight: 600;">Instructions</a> - Press and hold as<br>you inhale. Release as you exhale.
            </p>
        </div>

        <p class="noselect grad2" id="instructions2" style="position: absolute; top: 8vh; left: calc(50% - 8.5em); width: 17em; text-align: center; font-size: 2.8vh; opacity: 1.0; font-family: poppins; font-weight: 700; display: none">Welcome to Breathing Moon!<br />&nbsp;<br /><span style = "font-weight: 400; font-size: 2.4vh;line-height: 1.6vh;">It's just you in here.<br /><br />Have your breathing partner go to<br /><span id="roomLink" style="cursor:text; color:#407ecf; font-weight: 600; -webkit-touch-callout: all !important; -webkit-user-select: all !important; -khtml-user-select: all !important; -moz-user-select: all !important; -ms-user-select: all !important; user-select: all !important;"></p>

        <p class="noselect" id="instructions3" style="position: absolute; top: 120px; left: calc(50% - 300px); width: 600px; text-align: center; font-size: 32px; line-height: 32px; opacity: 1.0; font-family: poppins; font-weight: 200; color: lightcyan; text-shadow: 0 0 3px lightblue; display: none"></p>
    

</body>

</html>